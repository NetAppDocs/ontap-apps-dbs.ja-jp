---
sidebar: sidebar 
permalink: microsoft/win_hyperv_infra.html 
keywords: Windows,Hyper-V,VHDX,VM,Virtual 
summary: ONTAPを使用したHyper-Vストレージインフラ 
---
= NetApp上のHyper-Vストレージインフラ
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Hyper-Vストレージインフラは、ONTAPストレージシステムでホストできます。Hyper-VでVMファイルとそのディスクを格納するためのストレージは、次の図に示すように、NetApp LUNまたはNetApp CIFS共有を使用して提供できます。

image:win_image5.png["ネットアップ上のHyper-Vストレージインフラ、幅=624、高さ=338"]



== NetApp LUN上のHyper-Vストレージ

* Hyper-VサーバマシンでNetApp LUNをプロビジョニングします。詳細については、「link:win_san.html["SAN環境でのプロビジョニング"]. 」
* [Server Manager]の[Tools]セクションから[Hyper-V Manager]を開きます。
* Hyper-Vサーバを選択し、[Hyper-V Settings]をクリックします。
* VMとそのディスクをLUNとして格納するデフォルトのフォルダを指定します。これにより、Hyper-VストレージのデフォルトパスがLUNとして設定されます。VMのパスを明示的に指定する場合は、VMの作成時に指定できます。




== NetApp CIFS上のHyper-Vストレージ

このセクションに記載されている手順を開始する前に、link:win_smb.html["SMB環境でのプロビジョニング"]」。 NetApp CIFS共有でHyper-Vストレージを設定するには、次の手順を実行します。

. [Server Manager]の[Tools]セクションから[Hyper-V Manager]を開きます。
. Hyper-Vサーバを選択し、[Hyper-V Settings]をクリックします。
. VMとそのディスクをCIFS共有として格納するデフォルトのフォルダを指定します。これにより、Hyper-VストレージのCIFS共有としてデフォルトパスが設定されます。VMのパスを明示的に指定する場合は、VMの作成時に指定できます。


Hyper-Vの各VMには、物理ホストに提供されたNetApp LUNとCIFS共有を提供できます。この手順は、任意の物理ホストの場合と同じです。VMにストレージをプロビジョニングするには、次の方法を使用します。

* VM内のFCイニシエータを使用したストレージLUNの追加
* VM内のiSCSIイニシエータを使用したストレージLUNの追加
* VMへのパススルー物理ディスクの追加
* ホストからVMへのVHD / VHDXの追加




=== ベストプラクティス

* VMとそのデータがNetAppストレージに格納される場合、NetAppでは、NetApp重複排除をボリュームレベルで定期的に実行することを推奨しています。これにより、同一のVMがCSV共有またはSMB共有でホストされている場合、スペースが大幅に削減されます。重複排除はストレージコントローラ上で実行され、ホストシステムとVMのパフォーマンスには影響しません。
* Hyper-VでiSCSI LUNを使用する場合は、 `iSCSI Service (TCP-In) for Inbound` および `iSCSI Service (TCP-Out) for Outbound` Hyper-Vホストのファイアウォール設定。これにより、Hyper-VホストとNetAppコントローラとの間でiSCSIトラフィックが送受信されます。
* NetAppでは、[Allow Management Operating System to Share this Network Adapter for the Hyper-V virtual switch]オプションをオフにすることを推奨しています。これにより、VM専用のネットワークが作成されます。




=== 覚えておくべきこと

* 仮想ファイバチャネルを使用してVMをプロビジョニングするには、NポートID仮想化が有効なFC HBAが必要です。最大4つのFCポートがサポートされます。
* ホストシステムに複数のFCポートが設定されており、VMに提供されている場合は、マルチパスを有効にするためにMPIOをVMにインストールする必要があります。
* パススルーディスクではMPIOがサポートされないため、そのホストでMPIOが使用されている場合、パススルーディスクをホストにプロビジョニングすることはできません。
* VHD / VHDxファイルに使用するディスクは、割り当てに64Kのフォーマットを使用する必要があります。




=== さらに読みます

* FC HBAの詳細については、を参照してください。 http://mysupport.netapp.com/matrix/["NetApp Interoperability Matrix を参照してください"]。
* 仮想ファイバチャネルの詳細については、Microsoftの https://technet.microsoft.com/en-us/library/hh831413.aspx["Hyper-V仮想ファイバチャネルの概要"] ページ




== オフロードデータ転送

Microsoft ODX（コピーオフロード）を使用すると、ホストコンピュータを介さずに、ストレージデバイス内または互換性があるストレージデバイス間でデータを直接転送できます。ONTAPは、CIFSプロトコルとSANプロトコルの両方でODX機能をサポートしています。ODXを使用すると、コピーが同じボリューム内にある場合にパフォーマンスが向上したり、クライアントでのCPUとメモリの使用率が低下したり、ネットワークI/O帯域幅の使用率が低下したりする可能性があります。

ODXを使用すると、SMB共有内、LUN内、およびSMB共有とLUN（同じボリューム内の場合）間でファイルをコピーする処理が高速かつ効率的になります。この方法は、OS（VHD / VHDX）のゴールデンイメージの複数のコピーが同じボリューム内に必要な場合に役立ちます。コピーが同じボリューム内にある場合、同じゴールデンイメージの複数のコピーを作成する時間が大幅に短縮されます。ODXは、VMストレージを移動するためのHyper-Vストレージのライブマイグレーションでも適用されます。

複数のボリューム間でコピーを行う場合は、ホストベースのコピーに比べてパフォーマンスが大幅に向上することはありません。

CIFSでODX機能を有効にするには、NetAppストレージコントローラで次のCLIコマンドを実行します。

. CIFS用のODXを有効にします。
#権限レベルをdiagnosticに設定する
cluster：：> set -privilege diagnostic
+
....
#enable the odx feature
cluster::> vserver cifs options modify -vserver <vserver_name> -copy-offload-enabled true
....
+
....
#return to admin privilege level
cluster::> set privilege admin
....
. SANでODX機能を有効にするには、NetAppストレージコントローラで次のCLIコマンドを実行します。
#権限レベルをdiagnosticに設定する
cluster：：> set -privilege diagnostic
+
....
#enable the odx feature
cluster::> copy-offload modify -vserver <vserver_name> -scsi enabled
....
+
....
#return to admin privilege level
cluster::> set privilege admin
....




=== 覚えておくべきこと

* CIFSの場合、ODXを使用できるのは、クライアントとストレージサーバの両方でSMB 3.0およびODX機能がサポートされている場合だけです。
* SAN環境でODXを使用できるのは、クライアントとストレージサーバの両方でODX機能がサポートされている場合のみです。




=== さらに読みます

ODXの詳細については、を参照してください。 https://docs.netapp.com/us-en/ontap/smb-admin/improve-microsoft-remote-copy-performance-concept.html["Microsoftリモートコピーのパフォーマンスの向上"] および https://docs.netapp.com/us-en/ontap/san-admin/microsoft-offloaded-data-transfer-odx-concept.html["Microsoftオフロードデータ転送"] 。



== Hyper-Vクラスタリング：仮想マシンの高可用性と拡張性

フェイルオーバークラスタは、Hyper-Vサーバに対して高可用性と拡張性を提供します。フェイルオーバークラスタは、VMの可用性と拡張性を高めるために連携する独立したHyper-Vサーバのグループです。

Hyper-Vクラスタサーバ（ノード）は、物理ネットワークとクラスタソフトウェアによって接続されます。これらのノードは共有ストレージを使用して、構成、仮想ハードディスク（VHD）ファイル、SnapshotコピーなどのVMファイルを格納します。共有ストレージには、次に示すように、NetApp SMB/CIFS共有またはNetApp LUN上のCSVを使用できます。この共有ストレージは、一貫性のある分散されたネームスペースを提供し、クラスタ内のすべてのノードから同時にアクセスできます。したがって、クラスタ内の1つのノードに障害が発生すると、もう一方のノードがフェイルオーバーと呼ばれるプロセスによってサービスを提供します。フェイルオーバークラスタは、フェイルオーバークラスタマネージャスナップインおよびフェイルオーバークラスタリングWindows PowerShellコマンドレットを使用して管理できます。



=== クラスタ共有ボリューム

CSVを使用すると、NTFSまたはReFSボリュームとしてプロビジョニングされた同じNetApp LUNへの読み取り/書き込みアクセスを、フェイルオーバークラスタ内の複数のノードで同時に実行できます。CSVを使用すると、クラスタ化されたロールは、ドライブ所有権を変更したり、ボリュームをディスマウントおよび再マウントしたりすることなく、ノード間で迅速にフェイルオーバーできます。CSVを使用すると、フェイルオーバークラスタ内の多数のLUNを簡単に管理できます。CSVは、NTFSまたはReFS上に階層化された汎用クラスタファイルシステムを提供します。

image:win_image6.png["Hyper-Vフェイルオーバークラスタとネットアップ、幅=624、高さ=271"]



=== ベストプラクティス

* NetAppでは、内部クラスタ通信とCSVトラフィックが同じネットワークを経由しないように、iSCSIネットワークでクラスタ通信をオフにすることを推奨しています。
* NetAppでは、耐障害性とQoSを確保するために冗長なネットワークパス（複数のスイッチ）を使用することを推奨しています




=== 覚えておくべきこと

* CSVに使用するディスクは、NTFSまたはReFSでパーティショニングする必要があります。FATまたはFAT32でフォーマットされたディスクはCSVに使用できません。
* CSVに使用するディスクの割り当てには64Kのフォーマットを使用する必要があります。




=== さらに読みます

Hyper-Vクラスタの導入については、「付録B： link:win_deploy_hyperv.html["Hyper-Vクラスタの導入"]。



== Hyper-Vライブマイグレーション：VMの移行

VMの有効期間中に、Windowsクラスタ上の別のホストにVMを移動しなければならない場合があります。この処理は、ホストのシステムリソースが不足している場合や、メンテナンスのためにホストのリブートが必要な場合に必要になることがあります。同様に、VMを別のLUNまたはSMB共有に移動しなければならない場合があります。これは、現在のLUNまたは共有でスペースが不足しているか、パフォーマンスが想定よりも低い場合に必要になることがあります。Hyper-Vライブマイグレーションでは、実行中のVMを物理Hyper-Vサーバ間で移動します。VMの可用性には影響しません。フェイルオーバークラスタの一部であるHyper-Vサーバ間、またはどのクラスタにも属さない独立したHyper-Vサーバ間で、VMをライブマイグレーションできます。



=== クラスタ環境でのライブマイグレーション

VMは、クラスタのノード間でシームレスに移動できます。クラスタ内のすべてのノードが同じストレージを共有し、VMとそのディスクにアクセスできるため、VMの移行は瞬時に完了します。次の図に、クラスタ環境でのライブマイグレーションを示します。

image:win_image7.png["クラスタ環境でのライブマイグレーション、幅=580、高さ=295"]



=== ベストプラクティス

* ライブマイグレーショントラフィック専用のポートを用意します。
* 移行中のネットワーク関連の問題を回避するために、専用のホストライブマイグレーションネットワークを用意します。




=== さらに読みます

クラスタ環境へのライブマイグレーションの導入については、を参照してください。 link:win_deploy_hyperv_lmce.html["付録C：クラスタ環境へのHyper-Vライブマイグレーションの導入"]。



=== クラスタ環境外でのライブマイグレーション

VMは、クラスタ化されておらず、独立した2台のHyper-Vサーバ間でライブマイグレーションできます。このプロセスでは、シェアードナッシングまたはシェアードナッシングライブマイグレーションを使用できます。

* 共有ライブマイグレーションでは、VMはSMB共有に格納されます。したがって、VMをライブマイグレーションする場合、次に示すように、VMのストレージは中央のSMB共有に残り、もう一方のノードから即座にアクセスできます。


image:win_image8.png["非クラスタ環境での共有ライブマイグレーション、幅= 331、高さ= 271"]

* シェアードナッシングライブマイグレーションでは、各Hyper-Vサーバに独自のローカルストレージ（SMB共有、LUN、DAS）があり、VMのストレージはHyper-Vサーバに対してローカルになります。VMをライブマイグレーションすると、VMのストレージがクライアントネットワーク経由でデスティネーションサーバにミラーリングされ、その後VMが移行されます。DAS、LUN、またはSMB / CIFS共有に格納されているVMは、次の図に示すように、もう一方のHyper-Vサーバ上のSMB / CIFS共有に移動できます。2番目の図に示すように、LUNに移動することもできます。


image:win_image9.png["非クラスタ環境でSMB共有へのシェアードナッシングのライブマイグレーション（幅=624、高さ=384）"]

image:win_image10.png["非クラスタ環境でのLUNへのシェアードナッシングのライブマイグレーション（幅=624、高さ=384）"]



=== さらに読みます

クラスタ環境外へのライブマイグレーションの導入については、を参照してください。 link:win_deploy_hyperv_lmoce.html["付録D：クラスタ環境以外にHyper-Vライブマイグレーションを導入する"]。



=== Hyper-Vストレージのライブマイグレーション

VMの有効期間中に、VMストレージ（VHD / VHDX）を別のLUNまたはSMB共有に移動しなければならない場合があります。これは、現在のLUNまたは共有でスペースが不足しているか、パフォーマンスが想定よりも低い場合に必要になることがあります。

VMを現在ホストしているLUNまたは共有は、スペース不足、転用、またはパフォーマンスの低下を招く可能性があります。このような状況では、ダウンタイムを発生させずに、別のボリューム、アグリゲート、またはクラスタ上の別のLUNや共有にVMを移動できます。ストレージシステムにコピーオフロード機能がある場合は、この処理の方が高速です。NetAppストレージシステムは、CIFSおよびSAN環境ではデフォルトでコピーオフロードが有効になります。

ODX機能は、リモートサーバ上にある2つのディレクトリ間でファイル全体またはサブファイルのコピーを実行します。コピーは、サーバ間（ソースファイルとデスティネーションファイルが同じサーバ上にある場合は同じサーバ）でデータをコピーすることによって作成されます。コピーは、クライアントがソースからデータを読み取ったり、デスティネーションに書き込んだりすることなく作成されます。このプロセスにより、クライアントまたはサーバのプロセッサとメモリの使用量が削減され、ネットワークI/O帯域幅が最小限に抑えられます。同じボリューム内にある場合は、より高速にコピーできます。複数のボリューム間でコピーを行う場合は、ホストベースのコピーに比べてパフォーマンスが大幅に向上することはありません。ホストでコピー処理を開始する前に、ストレージシステムにコピーオフロードが設定されていることを確認してください。

VMストレージのライブマイグレーションをホストから開始すると、ソースとデスティネーションが特定され、コピーアクティビティがストレージシステムにオフロードされます。このアクティビティはストレージシステムによって実行されるため、ホストのCPU、メモリ、またはネットワークの使用量はごくわずかです。

NetAppストレージコントローラでは、次のようなODXシナリオがサポートされます。

* * IntraSVM。*データは同じSVMに所有されます。
* *ボリューム内、イントラノード。*ソースとデスティネーションのファイルまたはLUNは同じボリューム内に存在します。コピーはFlexCloneファイルテクノロジを使用して実行されるため、リモートコピーのパフォーマンスがさらに向上します。
* *ボリューム間、イントラノード。*ソースとデスティネーションのファイルまたはLUNは、同じノード上の異なるボリュームにあります。
* *ボリューム間、ノード間。*ソースとデスティネーションのファイルまたはLUNは、異なるノード上にある異なるボリュームにあります。
* * InterSVM。*データは別 々 のSVMに所有されています。
* *ボリューム間、イントラノード。*ソースとデスティネーションのファイルまたはLUNは、同じノード上の異なるボリュームにあります。
* *ボリューム間、ノード間。*ソースとデスティネーションのファイルまたはLUNは、異なるノード上の異なるボリュームにあります。
* *クラスタ間。* ONTAP 9.0以降では、SAN環境でのクラスタ間LUN転送でもODXがサポートされます。クラスタ間ODXはSANプロトコルでのみサポートされ、SMBではサポートされません。


移行が完了したら、VMを保持する新しいボリュームを反映するようにバックアップポリシーとレプリケーションポリシーを再設定する必要があります。以前に作成されたバックアップは使用できません。

VMストレージ（VHD / VHDX）は、次のストレージタイプ間で移行できます。

* DASとSMB共有
* DASとLUN
* SMB共有とLUN
* LUNカン
* SMBキヨウユウカン


image:win_image11.png["Hyper-Vストレージのライブマイグレーション、幅= 339、高さ= 352"]



=== さらに読みます

ストレージライブマイグレーションの導入については、を参照してください。 link:win_deploy_hyperv_slm.html["付録E：Hyper-Vストレージライブマイグレーションの導入"]。



== Hyper-Vレプリカ：仮想マシンのディザスタリカバリ

Hyper-Vレプリカは、プライマリサイトからセカンダリサイトのレプリカVMにHyper-V VMをレプリケートし、VMのディザスタリカバリを非同期で提供します。VMをホストするプライマリサイトのHyper-Vサーバをプライマリサーバと呼び、レプリケートされたVMを受け取るセカンダリサイトのHyper-Vサーバをレプリカサーバと呼びます。次の図に、Hyper-Vレプリカのシナリオ例を示します。Hyper-Vレプリカは、フェイルオーバークラスタの一部であるHyper-Vサーバ間、またはどのクラスタにも属さない独立したHyper-Vサーバ間で、VMに使用できます。

image:win_image12.png["Hyper-Vレプリカ、幅= 624、高さ= 201"]



=== レプリケーション

プライマリサーバ上のVMに対してHyper-Vレプリカが有効になると、最初のレプリケーションではレプリカサーバ上に同一のVMが作成されます。最初のレプリケーション後、Hyper-VレプリカはVMのVHDのログファイルを保持します。ログファイルは、レプリケーション頻度に応じてレプリカVHDに対して逆の順序で再生されます。このログと逆の順序を使用することで、最新の変更が非同期で保存され、レプリケートされます。想定される頻度でレプリケーションが実行されない場合は、アラートが発行されます。



=== 拡張レプリケーション

Hyper-Vレプリカは、セカンダリレプリカサーバをディザスタリカバリ用に構成できる拡張レプリケーションをサポートしています。セカンダリレプリカサーバは、レプリカサーバがレプリカVM上の変更を受信するように構成できます。拡張レプリケーションシナリオでは、プライマリサーバ上のプライマリVMの変更がレプリカサーバにレプリケートされます。その後'変更内容が拡張レプリカ・サーバに複製されますプライマリサーバとレプリカサーバの両方がダウンした場合にのみ、VMを拡張レプリカサーバにフェイルオーバーできます。



=== フェイルオーバー

フェイルオーバーは自動ではなく、手動で実行する必要があります。フェイルオーバーには、次の3種類があります。

* *フェイルオーバーのテスト。*このタイプは、レプリカVMがレプリカサーバで正常に起動し、レプリカVMで開始されることを確認するために使用されます。このプロセスでは、フェイルオーバー時にテストVMの複製が作成され、通常の本番レプリケーションには影響しません。
* *計画的フェイルオーバー。*このタイプは、計画的停止または予期される停止中にVMをフェイルオーバーするために使用されます。このプロセスはプライマリVMで開始されます。計画的フェイルオーバーを実行する前に、プライマリサーバでこのプロセスをオフにする必要があります。マシンがフェイルオーバーすると、Hyper-V Replicaはレプリカサーバ上のレプリカVMを起動します。
* *計画外フェイルオーバー。*このタイプは、予期しない停止が発生した場合に使用されます。このプロセスはレプリカVMで開始され、プライマリマシンに障害が発生した場合にのみ使用する必要があります。




=== リカバリ

VMのレプリケーションを設定するときに、リカバリポイントの数を指定できます。リカバリポイントは、レプリケートされたマシンからデータをリカバリできる時点を表します。



=== さらに読みます

* Hyper-Vレプリカをクラスタ環境外に導入する方法については、「link:win_deploy_hyperv_replica_oce.html["クラスタ環境外にHyper-Vレプリカを導入する"]. 」
* クラスタ環境へのHyper-Vレプリカの導入については、「link:win_deploy_hyperv_replica_ce.html["クラスタ環境へのHyper-Vレプリカの導入"]. 」

