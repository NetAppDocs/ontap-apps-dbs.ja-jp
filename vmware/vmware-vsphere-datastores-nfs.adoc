---
sidebar: sidebar 
permalink: vmware/vmware-vsphere-datastores-nfs.html 
keywords: vSphere, datastore, VMFS, FC, FCoE, NVMe/FC, iSCSI, NFS, vVols 
summary: このページでは、 VMware vSphere 環境に NetApp ONTAP ストレージ解決策を実装するためのベストプラクティスについて説明します。 
---
= NFS
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
vSphere を使用すると、エンタープライズクラスの NFS アレイを使用して、 ESXi クラスタ内のすべてのノードへのデータストアへの同時アクセスを提供できます。データストアのセクションで説明したように、 vSphere で NFS を使用すると、使いやすさが向上し、ストレージ効率を可視化できるというメリットがあります。

vSphere で ONTAP NFS を使用する際に推奨されるベストプラクティスは次のとおりです。

* ONTAP クラスタ内の各ノードの各 SVM で、 1 つの論理インターフェイス（ LIF ）を使用します。データストアごとの LIF の過去の推奨事項は不要になりました。直接アクセス（同じノード上のLIFとデータストア）を推奨しますが、一般にパフォーマンスへの影響は最小限（マイクロ秒）であるため、間接アクセスについて心配する必要はありません。
* VMware は、 VMware Infrastructure 3 以降で NFSv3 をサポートしています。vSphere 6.0 では NFSv4.1 がサポートされるようになり、 Kerberos セキュリティなどの高度な機能が使用できるようになりました。NFSv3 ではクライアント側のロックが使用され、 NFSv4.1 ではサーバ側のロックが使用されます。ONTAP ボリュームは両方のプロトコルでエクスポートできますが、 ESXi は 1 つのプロトコルでしかマウントできません。この単一プロトコルのマウントにより、他の ESXi ホストが同じデータストアを別のバージョンでマウントすることができるわけではありません。すべてのホストが同じバージョン、つまり同じロック形式を使用するように、マウント時に使用するプロトコルバージョンを指定してください。NFS のバージョンをホスト間で混在させないでください。可能であれば、ホストプロファイルを使用して準拠しているかどうかを確認します
+
** NFSv3 と NFSv4.1 間ではデータストアが自動変換されないため、新しい NFSv4.1 データストアを作成し、 Storage vMotion を使用して新しいデータストアに VM を移行します。
** に記載されている NFS v4.1 と相互運用性に関する表の注を参照してください https://mysupport.netapp.com/matrix/["NetApp Interoperability Matrix Tool で確認できます"^] をサポートするには、特定の ESXi パッチレベルが必要です。
** vSphere 8.0U2以降では、VMwareでNFSv3でのnconnectがサポートされます。nconnectの詳細については、 link:vmware-vsphere-network.html#nfs["こちらをご覧ください"]。


* NFS エクスポートポリシーは、 vSphere ホストによるアクセスの制御に使用されます。複数のボリューム（データストア）で 1 つのポリシーを使用できます。NFSv3 では、 ESXi で sys （ UNIX ）セキュリティ形式が使用され、 VM を実行するためにルートマウントオプションが必要となります。ONTAP では、このオプションはスーパーユーザと呼ばれます。スーパーユーザオプションを使用する場合は、匿名ユーザ ID を指定する必要はありません。の値が異なるエクスポートポリシールールに注意してください `-anon` および `-allow-suid` 原因 SVM検出がONTAP ツールで問題を検出できるかどうか。ポリシーの例を次に示します。
+
** Access Protocol：nfs（nfs3とnfs4の両方を含む）
** クライアント一致仕様： 192.168.42.21
** RO アクセスルール： sys
** RWアクセスルール:sys
** 匿名UIDの形式です
** superuser ： sys


* NetApp NFS Plug-in for VMware VAAIを使用する場合は、プロトコルをに設定する必要があります。 `nfs` ではなく `nfs3` エクスポートポリシールールが作成または変更されたとき。VAAIコピーオフロード機能を使用するには、データプロトコルがNFSv3であっても、NFSv4プロトコルが機能する必要があります。フロトコルノシテイ `nfs` NFSv3とNFSv4の両方のバージョンが含まれます。
* NFS データストアのボリュームは SVM のルートボリュームからジャンクションされるため、 ESXi がデータストアボリュームに移動してマウントするためにはルートボリュームへのアクセス権も必要となります。ルートボリューム、およびデータストアボリュームのジャンクションがネストされているその他のボリュームのエクスポートポリシーには、ESXiサーバに読み取り専用アクセスを許可するルールが含まれている必要があります。VAAIプラグインを使用したルートボリュームのポリシーの例を次に示します。
+
** Access Protocol：nfs（nfs3とnfs4の両方を含む）
** クライアント一致仕様： 192.168.42.21
** RO アクセスルール： sys
** RW Access Rule：never（ルートボリュームに最適なセキュリティ）
** 匿名UIDの形式です
** superuser：sys（VAAIを使用するルートボリュームの場合も必要）


* VMware vSphere 用の ONTAP ツール（最も重要なベストプラクティス）を使用：
+
** VMware vSphere 用の ONTAP ツールを使用してデータストアをプロビジョニングすると、エクスポートポリシーの自動管理が簡易化されます。
** プラグインを使用してVMwareクラスタ用のデータストアを作成するときは、単一のESXサーバではなくクラスタを選択します。これにより、データストアがクラスタ内のすべてのホストに自動的にマウントされます。
** プラグインのマウント機能を使用して、既存のデータストアを新しいサーバに適用します。
** VMware vSphere 用の ONTAP ツールを使用しない場合は、すべてのサーバ、または追加のアクセス制御が必要なサーバクラスタごとに、 1 つのエクスポートポリシーを使用します。


* ONTAP にはフレキシブルボリュームのネームスペース構造が用意されており、ジャンクションを使用してボリュームをツリーにまとめることができますが、このアプローチは vSphere には価値がありません。ストレージのネームスペース階層に関係なく、データストアのルートに各 VM 用のディレクトリが作成されます。そのため、単に SVM のルートボリュームに vSphere のボリュームのジャンクションパスをマウントすることがベストプラクティスです。これは、 VMware vSphere 用の ONTAP ツールでデータストアをプロビジョニングする方法です。ジャンクションパスがネストされていないと、ルートボリューム以外のボリュームに依存しているボリュームがないこと、またボリュームをオフラインにするか破棄するかによって意図的に他のボリュームへのパスに影響が及ぶこともありません。
* NFS データストアの NTFS パーティションのブロックサイズは 4K で十分です。次の図は、 vSphere ホストから ONTAP NFS データストアへの接続を示しています。


image:vsphere_ontap_image3.png["エラー：グラフィックイメージがありません"]

次の表に、 NFS のバージョンとサポートされる機能を示します。

|===
| vSphere の機能 | NFSv3 | NFSv4.1 


| vMotion と Storage vMotion | はい。 | はい。 


| 高可用性 | はい。 | はい。 


| フォールトトレランス | はい。 | はい。 


| DRS | はい。 | はい。 


| ホストプロファイル | はい。 | はい。 


| Storage DRS | はい。 | いいえ 


| ストレージ I/O の制御 | はい。 | いいえ 


| SRM の場合 | はい。 | いいえ 


| 仮想ボリューム | はい。 | いいえ 


| ハードウェアアクセラレーション（ VAAI ） | はい。 | はい。 


| Kerberos 認証 | いいえ | ○（ vSphere 6.5 以降で拡張して、 AES 、 krb5i ） 


| マルチパスのサポート | いいえ | はい。 
|===