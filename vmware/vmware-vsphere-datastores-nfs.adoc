---
sidebar: sidebar 
permalink: vmware/vmware-vsphere-datastores-nfs.html 
keywords: vSphere, datastore, NFS, vVols, NFSv3, NFSv4.1 
summary: このページでは、ONTAPおよびNFS接続のデータストアを使用してVMware vSphereを実装する際のベストプラクティスについて説明します。 
---
= NFS
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
ONTAPは、とりわけエンタープライズクラスのスケールアウトNASアレイです。ONTAPは、VMware vSphereを強化し、多数のESXiホストからNFS接続データストアに同時にアクセスできるようにします。VMFSファイルシステムの制限をはるかに超えています。vSphereでNFSを使用すると、操作が容易になり、ストレージ効率を可視化できるというメリットがあります（を参照link:vmware-vsphere-datastores-top.html["データストア"]）。

vSphere で ONTAP NFS を使用する際に推奨されるベストプラクティスは次のとおりです。

* VMware vSphere 用の ONTAP ツール（最も重要なベストプラクティス）を使用：
+
** ONTAP tools for VMware vSphereを使用して、エクスポートポリシーの自動管理が簡易化されるため、データストアをプロビジョニングできます。
** プラグインを使用してVMwareクラスタ用のデータストアを作成するときは、単一のESXサーバではなくクラスタを選択します。これにより、データストアがクラスタ内のすべてのホストに自動的にマウントされます。
** プラグインのマウント機能を使用して、既存のデータストアを新しいサーバに適用します。
** VMware vSphere 用の ONTAP ツールを使用しない場合は、すべてのサーバ、または追加のアクセス制御が必要なサーバクラスタごとに、 1 つのエクスポートポリシーを使用します。


* ONTAP クラスタ内の各ノードの各 SVM で、 1 つの論理インターフェイス（ LIF ）を使用します。データストアごとの LIF の過去の推奨事項は不要になりました。直接アクセス（LIFとデータストアが同じノード上にある場合）を推奨しますが、一般にパフォーマンスへの影響は最小限（マイクロ秒）であるため、間接アクセスについて心配する必要はありません。
* fpolicyを使用する場合は、必ず.lckファイルを除外してください。これらのファイルは、VMの電源がオンになっているときにvSphereでロックするために使用されます。
* 現在サポートされているすべてのバージョンのVMware vSphereで、NFS v3とv4.1の両方を使用できます。nconnectの公式サポートは、NFS v3ではvSphere 8.0 Update 2、NFS v4.1ではUpdate 3に追加されました。NFS v4.1のvSphereは、セッショントランキング、Kerberos認証、整合性を維持したKerberos認証を引き続きサポートします。セッショントランキングにはONTAP 9.14.1以降のバージョンが必要であることに注意してください。nconnect機能の詳細と、nconnect機能によってパフォーマンスがどのように向上するかについては、を参照link:https://docs.netapp.com/us-en/netapp-solutions/virtualization/vmware-vsphere8-nfsv3-nconnect.html["NetAppおよびVMwareでのNFSv3 nconnect機能"]してください。


[TIP]
====
* vSphere 8のnconnectの最大値は4で、デフォルト値は1です。vSphereの最大値は、高度な設定を使用してホスト単位で上げることができますが、通常は必要ありません。
* 1つのTCP接続で提供できるパフォーマンスよりも高いパフォーマンスを必要とする環境では、値を4にすることを推奨します。
* ESXiのNFS接続数は256に制限されており、各nconnect接続数がその合計にカウントされることに注意してください。たとえば、nconnect=4の2つのデータストアは、合計8つの接続としてカウントされます。
* 本番環境に大規模な変更を実装する前に、nconnectが環境に与えるパフォーマンスへの影響をテストすることが重要です。


====
* NFSv3とNFSv4.1では、異なるロックメカニズムが使用されていることに注目してください。NFSv3ではクライアント側ロックが使用され、NFSv4.1ではサーバ側ロックが使用されます。ONTAPボリュームは両方のプロトコルでエクスポートできますが、ESXiは1つのプロトコルでしかデータストアをマウントできません。ただしこれは、他のESXiホストが異なるバージョンを使用して同じデータストアをマウントできないという意味ではありません。問題を回避するには、マウント時に使用するプロトコルのバージョンを指定して、すべてのホストで同じバージョン、つまり同じロック形式を使用するようにする必要があります。NFSバージョンをホスト間で混在させないことが重要です。可能であれば、ホストプロファイルを使用して準拠を確認します。
+
** NFSv3 と NFSv4.1 間ではデータストアが自動変換されないため、新しい NFSv4.1 データストアを作成し、 Storage vMotion を使用して新しいデータストアに VM を移行します。
** サポートに必要なESXiのパッチレベルについては、でNFS v4.1のInteroperabilityテーブルに関する注意事項を参照してlink:https://mysupport.netapp.com/matrix/["NetApp Interoperability Matrix Tool で確認できます"^]ください。


* で説明したように、link:vmware/vmware-vsphere-settings.html["設定"]vSphere CSI for Kubernetesを使用していない場合は、 https://knowledge.broadcom.com/external/article/386364/reducing-excessive-vsan-cnssync-warnings.html["VMware KB 386364"^]
* NFSエクスポートポリシールールは、vSphereホストによるアクセスの制御に使用されます。複数のボリューム（データストア）で 1 つのポリシーを使用できます。NFSの場合、ESXiではsys（UNIX）セキュリティ形式が使用され、VMを実行するにはルートマウントオプションが必要です。ONTAP では、このオプションはスーパーユーザと呼ばれます。スーパーユーザオプションを使用する場合は、匿名ユーザ ID を指定する必要はありません。との `-allow-suid`値が異なるエクスポートポリシールールが設定されていると、ONTAP toolsでSVM検出の問題が発生する可能性があることに注意して `-anon`ください。IPアドレスをカンマで区切って指定し、データストアをマウントするvmkernelポートアドレスをスペースなしで指定する必要があります。ポリシールールの例を次に示します。
+
** Access Protocol：nfs（nfs3とnfs4の両方を含む）
** クライアント一致のホスト名、IPアドレス、ネットグループ、またはドメインのリスト：192.168.42.21,192.168.42.22
** ROアクセスルール：任意
** RWアクセスルール：任意
** 匿名ユーザのマッピング先ユーザID：65534
** スーパーユーザセキュリティタイプ：任意
** SETATTRでsetuidビットを保持：TRUE
** デバイスの作成を許可：true


* NetApp NFS Plug-in for VMware VAAIを使用する場合は、エクスポートポリシーを作成または変更するときにプロトコルをに設定する必要があります `nfs`。VAAIコピーオフロードが機能するためにはNFSv4プロトコルが必要です。プロトコルをに指定する `nfs`と、NFSv3とNFSv4の両方のバージョンが自動的に選択されます。これは、データストアタイプがNFS v3として作成されている場合でも必要です。
* NFS データストアのボリュームは SVM のルートボリュームからジャンクションされるため、 ESXi がデータストアボリュームに移動してマウントするためにはルートボリュームへのアクセス権も必要となります。ルートボリューム、およびデータストアボリュームのジャンクションがネストされているその他のボリュームのエクスポートポリシーには、ESXiサーバに読み取り専用アクセスを許可するルールが含まれている必要があります。VAAIプラグインを使用したルートボリュームのポリシーの例を次に示します。
+
** アクセスプロトコル：NFS
** クライアント一致の仕様：192.168.42.21、192.168.42.22
** RO アクセスルール： sys
** RW Access Rule：never（ルートボリュームに最適なセキュリティ）
** 匿名UIDの形式です
** superuser：sys（VAAIを使用するルートボリュームの場合も必要）


* ONTAP にはフレキシブルボリュームのネームスペース構造が用意されており、ジャンクションを使用してボリュームをツリーにまとめることができますが、このアプローチは vSphere には価値がありません。ストレージのネームスペース階層に関係なく、データストアのルートに各 VM 用のディレクトリが作成されます。そのため、単に SVM のルートボリュームに vSphere のボリュームのジャンクションパスをマウントすることがベストプラクティスです。これは、 VMware vSphere 用の ONTAP ツールでデータストアをプロビジョニングする方法です。ジャンクションパスがネストされていないと、ルートボリューム以外のボリュームに依存しているボリュームがないこと、またボリュームをオフラインにするか破棄するかによって意図的に他のボリュームへのパスに影響が及ぶこともありません。
* NFS データストアの NTFS パーティションのブロックサイズは 4K で十分です。次の図は、 vSphere ホストから ONTAP NFS データストアへの接続を示しています。


image:vsphere_ontap_image3.png["vSphereホストからONTAP NFSデータストアへの接続"]

次の表に、 NFS のバージョンとサポートされる機能を示します。

|===
| vSphere の機能 | NFSv3 | NFSv4.1 


| vMotion と Storage vMotion | はい。 | はい。 


| 高可用性 | はい。 | はい。 


| フォールトトレランス | はい。 | はい。 


| DRS | はい。 | はい。 


| ホストプロファイル | はい。 | はい。 


| Storage DRS | はい。 | いいえ 


| ストレージ I/O の制御 | はい。 | いいえ 


| SRM の場合 | はい。 | いいえ 


| 仮想ボリューム | はい。 | いいえ 


| ハードウェアアクセラレーション（ VAAI ） | はい。 | はい。 


| Kerberos 認証 | いいえ | ○（ vSphere 6.5 以降で拡張して、 AES 、 krb5i ） 


| マルチパスのサポート | いいえ | ○（ONTAP 9.14.1） 
|===