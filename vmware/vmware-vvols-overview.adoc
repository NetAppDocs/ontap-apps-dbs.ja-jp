---
sidebar: sidebar 
permalink: vmware/vmware-vvols-overview.html 
keywords: tr-4400, vvols, ontap, virtual volumes 
summary: ここでは、VMware vSphere Virtual Volume（VVOL）とONTAPの概要を説明します。 
---
= 概要
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
ONTAPは、20年以上にわたって業界をリードするVMware vSphere環境向けストレージ解決策であり、コストを削減しながら管理を簡易化する革新的な機能を継続的に追加しています。

本ドキュメントでは、VMware vSphere Virtual Volumes（VVOL）向けのONTAP 機能について説明します。最新の製品情報やユースケース、導入を合理化してエラーを削減するためのベストプラクティスなどを紹介します。


NOTE: このドキュメントは、これまでに公開されていたテクニカルレポート_TR-4400：『VMware vSphere Virtual Volumes（vVol）with ONTAP _』を差し替えます。

ベストプラクティスは、ガイドや互換性リストなどの他のドキュメントを補うものです。ラボテストに基づいて開発されており、ネットアップのエンジニアやお客様は広範な現場経験を積んでいます。効果的またはサポートされている唯一の手法ではないかもしれませんが、一般的には、ほとんどのお客様のニーズを満たす最もシンプルなソリューションです。


NOTE: 本ドキュメントが更新され、vSphere 8.0 Update 3、ONTAP tools 10.4リリース、および新しいNetApp ASAシステムに搭載された新しいvVol機能が追加されました。



== Virtual Volumes（VVol）の概要

ネットアップは2012年にVMwareとの連携を開始し、vSphere APIs for Storage Awareness（VASA）for vSphere 5のサポートを開始しました。この初期のVASA Providerでは、プロファイルにストレージ機能を定義することができました。このプロファイルを使用すると、プロビジョニング時やポリシーへの準拠状況の確認時にデータストアをフィルタリングできます。時間の経過とともに、プロビジョニングの自動化を可能にする新しい機能が追加されたり、仮想ボリューム（VVol）が追加されたりして、個 々 のストレージオブジェクトが仮想マシンファイルと仮想ディスクに使用されたりします。これらのオブジェクトには、LUN、ファイルが含まれ、vSphere 8-NVMeネームスペース（ONTAP tools 9.13P2で使用）に対応できるようになりました。NetAppは、2015年にvSphere 6でリリースされたVVOLのリファレンスパートナーとしてVMwareと緊密に連携し、またvSphere 8でNVMe over Fabricsを使用したVVOLの設計パートナーとしても協力しました。ネットアップでは、ONTAP の最新機能を活用できるように、VVOLの機能を継続的に強化しています。

注意が必要なコンポーネントは次のとおりです。



=== VASA Provider

VMware vSphereとストレージシステムの間の通信を処理するソフトウェアコンポーネントです。ONTAP の場合、VASA ProviderはONTAP Tools for VMware vSphere（ONTAP tools for VMware vSphere）と呼ばれるアプライアンスで実行されます。ONTAP toolsには、vCenterプラグイン、VMware Site Recovery Manager用のStorage Replication Adapter（SRA）、独自の自動化を構築するためのREST APIサーバも含まれています。ONTAP toolsを設定してvCenterに登録すると、ONTAP システムを直接操作する必要はほとんどなくなります。これは、必要なストレージのほぼすべてをvCenter UIから直接、またはREST APIによる自動化を通じて管理できるためです。



=== プロトコルエンドポイント（PE）

プロトコルエンドポイントは、ESXiホストとVVOLデータストアの間のI/Oのプロキシです。ONTAP VASA Providerは、VVOLデータストアのFlexVolごとに1つのプロトコルエンドポイントLUN（サイズ4MB）、またはデータストア内のFlexVolボリュームをホストしているストレージノードのNFSインターフェイス（LIF）ごとに1つのNFSマウントポイントを自動的に作成します。ESXiホストでは、これらのプロトコルエンドポイントは、個 々 のVVOL LUNや仮想ディスクファイルではなく直接マウントされます。プロトコルエンドポイントは、必要なインターフェイスグループやエクスポートポリシーとともにVASA Providerによって自動的に作成、マウント、アンマウント、および削除されるため、管理する必要はありません。



=== 仮想プロトコルエンドポイント（VPE）

vSphere 8の新機能では、VVOLでNVMe over Fabrics（NVMe-oF）を使用する場合、プロトコルエンドポイントの概念はONTAP には関係ありません。代わりに、最初のVMの電源がオンになるとすぐに、各ANAグループのESXiホストによって仮想PEが自動的にインスタンス化されます。ONTAP では、データストアで使用されるFlexVol ボリュームごとにANAグループが自動的に作成されます。

VVOLにNVMe-oFを使用するもう1つの利点は、VASA Providerでバインド要求が不要であることです。代わりに、VVOLバインド機能はVPEに基づいてESXiホストが内部的に処理します。これにより、VVolのバインドストームがサービスに影響する可能性が低くなります。

詳細については、を参照してください https://docs.vmware.com/en/VMware-vSphere/8.0/vsphere-storage/GUID-23B47AAC-6A31-466C-84F9-8CF8F1CDD149.html["NVMeと仮想ボリューム"^] オン https://docs.vmware.com/en/VMware-vSphere/8.0/vsphere-storage/GUID-23B47AAC-6A31-466C-84F9-8CF8F1CDD149.html["VMware.com"^]



=== Virtual Volumeデータストア

| 仮想ボリューム データストアは、VASA プロバイダーによって作成および管理されるvVolsコンテナの論理データストア表現です。コンテナは、VASA プロバイダーによって管理されるストレージ システムからプロビジョニングされたストレージ容量のプールを表します。ONTAPツールは、複数のFlexVolボリューム (バックアップ ボリュームと呼ばれる) を単一のvVolsデータストアに割り当てることをサポートしており、これらのvVolsデータストアはONTAPクラスタ内の複数のノードにまたがって、異なる機能を持つフラッシュ システムとハイブリッド システムを組み合わせることができます。管理者は、プロビジョニング ウィザードまたはREST APIを使用して新しいFlexVolボリュームを作成するか、使用可能な場合はバックアップ ストレージとして事前に作成されたFlexVolボリュームを選択できます。



=== 仮想ボリューム（VVol）

vVols は、 vVolsデータストアに保存される実際の仮想マシン ファイルとディスクです。vVol (単数形) という用語を使用すると、単一の特定のファイル、LUN、または名前空間を指します。ONTAP は、データストアが使用するプロトコルに応じて、NVMe 名前空間、LUN、またはファイルを作成します。vVolsにはいくつかの異なるタイプがあります。最も一般的なタイプは、Config（VMFS が存在する唯一のタイプで、VM の VMX ファイルなどのメタデータ ファイルが含まれます）、Data（仮想ディスクまたは VMDK）、および Swap（VM の電源オン時に作成される）です。VMware VM 暗号化によって保護されるvVols のタイプは Other になります。VMware VM 暗号化を、 ONTAPボリュームまたはアグリゲート暗号化と混同しないでください。



== ポリシーベースの管理

VMware vSphere APIs for Storage Awareness (VASA) を使用すると、VM 管理者はストレージ チームとやり取りすることなく、VM のプロビジョニングに必要なあらゆるストレージ機能を簡単に使用できるようになります。VASA 以前は、VM 管理者は VM ストレージ ポリシーを定義できましたが、多くの場合、ドキュメントや命名規則を使用して、ストレージ管理者と協力して適切なデータストアを特定する必要がありました。VASA を使用すると、適切な権限を持つ vCenter 管理者は、vCenter ユーザーが VM のプロビジョニングに使用できるさまざまなストレージ機能を定義できます。VM ストレージ ポリシーとデータストア機能のマッピングにより、vCenter は選択可能な互換性のあるデータストアのリストを表示できるようになり、また、VCF (旧称 Aria および vRealize) Automation やVMware vSphere Kubernetes Service (VKS) などの他のテクノロジを使用して、割り当てられたポリシーからストレージを自動的に選択できるようになります。このアプローチは、ストレージポリシーベースの管理と呼ばれます。VASA プロバイダー ルールと VM ストレージ ポリシーは従来のデータストアでも使用できますが、ここではvVolsデータストアに焦点を当てます。



=== VMストレージ ポリシー

仮想マシンストレージポリシーは、vCenterの[Policies and Profiles]に作成されます。VVOLの場合は、NetApp VVOLストレージタイププロバイダから提供されるルールを使用してルールセットを作成します。ONTAP tools 10.Xでは、VMストレージポリシー自体にストレージ属性を直接指定できるため、ONTAP tools 9.Xよりもシンプルなアプローチが採用されています。

前述したように、ポリシーを使用すると、VMまたはVMDKのプロビジョニングタスクを合理化できます。適切なポリシーを選択するだけで、そのポリシーをサポートするvVolデータストアがVASA Providerに表示され、準拠している個 々 のFlexVol volumeにvVolが配置されます。



=== ストレージポリシーを使用してVMを導入します

image::vvols-image3.png[ストレージポリシーを使用して仮想マシンを導入します,800,480]

VM がプロビジョニングされると、VASA プロバイダーはコンプライアンスを継続的にチェックし、バックアップ ボリュームがポリシーに準拠しなくなった場合は vCenter でアラームを発行して VM 管理者に警告します。



=== VMストレージポリシーへの準拠

image::vvols-image4.png[仮想マシンストレージポリシーへの準拠,320,100]



== NetApp VVOLのサポート

ONTAP は、2012 年の最初のリリース以来、VASA 仕様をサポートしています。他のNetAppストレージ システムでも VASA がサポートされている可能性がありますが、このドキュメントでは現在サポートされているONTAP 9 のリリースに焦点を当てています。



=== ONTAP

NetApp は、 AFF、 ASA、 FASシステム上のONTAP 9 に加えて、 ONTAP Select、VMware Cloud on AWS を使用したAmazon FSx for NetApp 、Azure VMware Solution を使用したAzure NetApp Files 、 Google Cloud NetApp Volumes 、Equinix のNetApp Private Storage 上の VMware ワークロードをサポートしていますが、具体的な機能はサービス プロバイダーや利用可能なネットワーク接続によって異なる場合があります。

公開時点では、ハイパースケーラー環境は従来の NFS v3 データストアのみに制限されているため、 vVolsはオンプレミスのONTAPシステム、またはオンプレミスシステムの全機能を提供するクラウド接続システム (世界中のNetAppパートナーやサービス プロバイダーがホストしているシステムなど) でのみ使用できます。

ONTAP の詳細については、を参照してください https://docs.netapp.com/us-en/ontap-family/["ONTAP 製品ドキュメント"^]_

ONTAP およびVMware vSphereのベストプラクティスの詳細については、を参照してください link:vmware-vsphere-overview.html["TR-4597"^]_



== ONTAPでVVOLを使用するメリット

VMware は 2015 年に VASA 2.0 でvVolsサポートを導入したとき、これを「外部ストレージ (SAN/NAS) の新しい運用モデルを提供する統合および管理フレームワーク」と説明しました。この運用モデルは、 ONTAPストレージと組み合わせることで、いくつかの利点をもたらします。



=== ポリシーベースの管理

セクション 1.2 で説明したように、ポリシーベースの管理により、VM をプロビジョニングし、その後、事前定義されたポリシーを使用して管理できるようになります。これは、いくつかの点で IT 運用に役立ちます。

* *速度を上げます。*ONTAPツールを使用すると、vCenter 管理者がストレージ プロビジョニングアクティビティのためにストレージ チームにチケットを開く必要がなくなります。ただし、vCenter およびONTAPシステムでのONTAPツール RBAC ロールでは、必要に応じて特定の機能へのアクセスを制限することにより、独立したチーム (ストレージ チームなど) または同じチームによる独立したアクティビティが引き続き許可されます。
* *よりスマートなプロビジョニング。*ストレージシステムの機能をVASA APIを通じて公開できるため、VM管理者がストレージシステムの管理方法を理解しなくても、プロビジョニングワークフローで高度な機能を活用できます。
* *プロビジョニングの高速化。* 1つのデータストアでさまざまなストレージ機能をサポートし、VMポリシーに基づいてVMに応じて自動的に選択できます。
* *間違いを避けてください。*ストレージとVMのポリシーは事前に開発され、必要に応じて適用されます。VMをプロビジョニングするたびにストレージをカスタマイズする必要はありません。コンプライアンスアラームは、定義されたポリシーからストレージ機能が逸脱すると生成されます。前述したように、SCPは初期プロビジョニングを予測可能かつ反復可能にし、SCPに基づいてVMストレージポリシーを設定することで正確な配置を保証します。
* *より優れた容量管理*VASAツールとONTAPツールを使用すると、必要に応じて個 々 のアグリゲートレベルまでストレージ容量を表示し、容量が少なくなり始めた場合に複数のレイヤからアラートを受け取ることができます。




=== 最新のSANでVMをきめ細かく管理

ファイバ チャネルと iSCSI を使用する SAN ストレージ システムは、VMware が ESX 用にサポートした最初のシステムでしたが、ストレージ システムから個々の VM ファイルとディスクを管理する機能がありませんでした。代わりに、LUN がプロビジョニングされ、VMFS が個々のファイルを管理します。このため、ストレージ システムが個々の VM ストレージのパフォーマンス、クローン作成、および保護を直接管理することは困難です。vVolsは、NFS ストレージを使用しているお客様が既に享受しているストレージの細分性と、 ONTAPの堅牢でハイパフォーマンスSAN 機能を実現します。

現在、vSphere 8 およびONTAP tools for VMware vSphereと、従来の SCSI ベース プロトコルのvVolsで使用されるのと同じきめ細かい制御が、NVMe over Fabrics を使用する最新のファイバー チャネル SAN でも利用できるようになり、大規模なパフォーマンスがさらに向上します。vSphere 8.0 Update 1 では、ハイパーバイザーストレージ スタックで I/O 変換を行わずに、 vVolsを使用して完全なエンドツーエンドのNVMe ソリューションを展開できるようになりました。



=== 優れたストレージオフロード機能

VAAI はストレージにオフロードされるさまざまな操作を提供しますが、VASA プロバイダーによって対処されるギャップがいくつかあります。SAN VAAI は、VMware 管理のスナップショットをストレージ システムにオフロードできません。NFS VAAI は VM 管理スナップショットをオフロードできますが、ストレージ ネイティブ スナップショットを備えた VM には制限があります。vVols は仮想マシン ディスクに個別の LUN、名前空間、またはファイルを使用するため、 ONTAP はファイルまたは LUN を迅速かつ効率的にクローンして、デルタ ファイルを必要としない VM 単位のスナップショットを作成できます。NFS VAAI は、ホット (電源オン) Storage vMotion 移行のクローン操作のオフロードもサポートしていません。VAAI を従来の NFS データストアで使用する場合、移行のオフロードを可能にするには、VM の電源をオフにする必要があります。ONTAPツールの VASA プロバイダーは、ホット移行とコールド移行のためのストレージ効率の高いクローンをほぼ瞬時に作成できるほか、 vVolsのボリューム間移行のためのほぼ瞬時のコピーもサポートします。これらの大きなストレージ効率の利点により、 vVolsワークロードを最大限に活用できる可能性があります。 https://www.netapp.com/pdf.html?item=/media/8207-flyer-efficiency-guaranteepdf.pdf["容量削減保証"] プログラム。同様に、VAAI を使用したボリューム間クローンでは要件を満たせない場合でも、 vVolsによるコピーエクスペリエンスの改善により、ビジネス上の課題を解決できる可能性があります。



=== VVOLの一般的なユースケース

これらのメリットに加えて、VVOLストレージの一般的なユースケースを次に示します。

* *仮想マシンのオンデマンドプロビジョニング*
+
** プライベートクラウドまたはサービスプロバイダのIaaS：
** ARIA（旧称vRealize）スイートやOpenStackなどによる自動化とオーケストレーションを活用できます。


* *ファーストクラスディスク（FCD）*
+
** VMware vSphere Kubernetes Service (VKS) 永続ボリューム。
** 独立した VMDK ライフサイクル管理を通じて Amazon EBSのようなサービスを提供します。


* *一時VMのオンデマンドプロビジョニング*
+
** テスト/開発ラボ
** トレーニング環境






=== VVOLの一般的なメリット

VVOLを最大限に活用すると（上記のユースケースなど）、具体的に次のような機能強化が実現します。

* クローンは、単一のボリューム内、またはONTAPクラスタ内の複数のボリュームにわたって迅速に作成されます。これは、従来の VAAI 対応クローンに比べて利点があります。ストレージ効率も優れています。ボリューム内のクローンでは、 FlexCloneボリュームに似たONTAPファイル クローンを使用し、ソース vVol ファイル/LUN/名前空間からの変更のみを保存します。そのため、本番環境やその他のアプリケーション用の長期的な VM は、迅速に作成され、最小限のスペースで済み、VM レベルの保護 ( VMware vSphere用のNetApp SnapCenterプラグイン、VMware 管理スナップショット、または VADP バックアップを使用) とパフォーマンス管理 ( ONTAP QoS を使用) のメリットを享受できます。VASA を使用すると、コピーが完了する前にクローンを作成し、宛先でそのクローンにアクセスできるため、ボリューム間のクローン作成は VAAI よりもvVolsの方がはるかに高速になります。データ ブロックはバックグラウンド プロセスとしてコピーされ、宛先 vVol に入力されます。これは、従来の LUN に対するONTAP の無停止 LUN 移動の動作と似ています。
* VVOLは、vSphere CSIでTKGを使用する場合に理想的なストレージテクノロジであり、vCenter管理者が管理する個別のストレージクラスと容量を提供します。
* FCD VMDK は、その名前が示すように vSphere の第一級オブジェクトであり、接続されている可能性のある VM とは別に独立して管理できるライフサイクルを備えているため、Amazon EBSのようなサービスを FCD を通じて提供できます。

